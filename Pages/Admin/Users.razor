@page "/Admin/Users"
@layout MainLayout
@inject UsersService _usersService
@inject RolesService _roleService
@inject ToastService _toastService

<DataGrid Config="DataGridConfig" />

@code {
    public DataGridConfig DataGridConfig { get; set; }
    protected override async Task OnInitializedAsync()
    {
        DataGridConfig = new DataGridConfig();
        DataGridConfig.Title = "لیست کاربر ها";
        DataGridConfig.GroupActions = new List<DataGridRowActionGroup>
        {
            new DataGridRowActionGroup
            {
                Width = "200px",
                Actions = new List<DataGridRowAction>
                {
                    new DataGridRowAction
                    {
                        ButtonClass = ButtonsClass.btn_primary,
                        IconClass=IconsClass.fa_pen_to_square,
                        OnClick = (rowitem) =>
                        {

                        }
                    }
                }
            }
        };

        DataGridConfig.Columns = new List<DataGridColumn>
        {
            new DataGridColumn
            {
                PropertyName = "Id",
                Title = "شناسه"
            },
            new DataGridColumn
            {
                PropertyName = "FirstName",
                Title = "نام"
            },
            new DataGridColumn
            {
                PropertyName = "LastName",
                Title = "نام خوانوادگی"
            },
            new DataGridColumn
            {
                PropertyName = "UserName",
                Title = "نام کاربری"
            },
            new DataGridColumn
            {
                PropertyName = "Email",
                Title = "ایمیل"
            },
            new DataGridColumn
            {
                PropertyName = "Tall",
                Title = "قد"
            },
        };
        DataGridConfig.LoadDataAsync = () =>
        {
            return Task.FromResult(_usersService.Read().Cast<dynamic>().ToList());
        };
        DataGridConfig.DeleteRowButtonDataGridConfig.OnOpenModal = (row) =>
        {
            return new ConfirmModal
                {
                    Title = "هشدار",
                    Content = "ایا از حذف این سطر مطمئن هستید؟",
                    OnConfirm = () =>
{
        _usersService.Delete(Convert.ToInt32(row["Id"]));
    }
                };
        };
        DataGridConfig.EditRowButtonDataGridConfig.OnOpenModal = (row) =>
        {
            return new InputModal
                {
                    Title = "ویرایش کاربر",
                    ColumnCount = 2,
                    Size = ModalSize.modal_xl,
                    OnSubmit = (form) =>
{
        int Id = form["Id"].ToInt32();

        var Entiry = _usersService.Read(Id);
        Entiry.FirstName = form["FirstName"];
        Entiry.LastName = form["LastName"];
        Entiry.UserName = form["UserName"];
        Entiry.UserName = form["Password"];
        Entiry.Email = form["Email"];
        Entiry.Tall = form["Tall"].ToInt32();
    //_usersService.Update(User.Id, User);
        return true;
    },
                    Fields = new List<ItemField>
                                                                            {
                                new ItemField
                                {
                                    PropertyName = "Id",
                                    Title = "شناسه",
                                    Value = row["Id"],
                                    ValuType = ModelEditorValueType.Readonly
                                },
                                new ItemField
                                {
                                    PropertyName = "FirstName",
                                    Title = "نام",
                                    Value = row["FirstName"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "LastName",
                                    Title = "نام خوانوادگی",
                                    Value = row["LastName"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "UserName",
                                    Title = "نام کاربری",
                                    Value = row["UserName"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "Email",
                                    Title = "ایمیل",
                                    Value = row["Email"],
                                    ValuType = ModelEditorValueType.Text,
                                    ValidationRules = new List<ValidationItemField>
                                    {
                                        new Regex
                                        {
                                            Pattern = "^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$",
                                            ErrorMessage = "فرمت ایمیل درست نیست."
                                        }
                                    }
                                },
                                new ItemField
                                {
                                    PropertyName = "IsActive",
                                    Title = "فعال",
                                    Value = row["IsActive"],
                                    ValuType = ModelEditorValueType.CheckBox,
                                    // ValidationRules = new List<ValidationItemField>
                                    // {
                                    //     new Regex
                                    //     {
                                    //         Pattern = "^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$",
                                    //         ErrorMessage = "فرمت ایمیل درست نیست."
                                    //     }
                                    // }
                                },
                                new ItemField
                                {
                                    PropertyName = "Tall",
                                    Title = "قد",
                                    ValuType = ModelEditorValueType.Number
                                },
                                new ItemField
                                {
                                    PropertyName = "Password",
                                    Title = "رمز عبور",
                                    Value = row["Password"],
                                    ValuType = ModelEditorValueType.Password
                                },
                                new SelectiveItemField
                                {
                                    PropertyName = "RolesId",
                                    Title = "نقش",
                                    ValuType = ModelEditorValueType.Selective,
                                    Items = _roleService.Read().Select(r=>new SelectItem
                                    {
                                        Id = r.Id,
                                    Title = r.Title
                                    }).ToList(),
                                    ErrorMessage = "انتخاب نقش اجباری است"
                                },
                        }
                };
        };
        DataGridConfig.NewRowButtonDataGridConfig = new NewRowButtonDataGridConfig
            {
                ButtonTitle = "کاربر جدید",
                IsShow = true,
                OnOpenModal = () =>
                {
                    return new InputModal
                    {
                        Title = "ایجاد کاربر",
                        ColumnCount = 2,
                        Size = ModalSize.modal_xl,
                        Fields = new List<ItemField>
                        {
                                new ItemField
                                {
                                    PropertyName = "FirstName",
                                    Title = "نام",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "LastName",
                                    Title = "نام خوانوادگی",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "UserName",
                                    Title = "نام کاربری",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "Email",
                                    Title = "ایمیل",
                                    ValuType = ModelEditorValueType.Text,
                                    ValidationRules = new List<ValidationItemField>
                                    {
                                        new Regex
                                        {
                                            Pattern = "^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$",
                                            ErrorMessage = "فرمت ایمیل درست نیست."
                                        }
                                    }
                                }, 
                                new ItemField
                                {
                                    PropertyName = "IsActive",
                                    Title = "فعال",
                                    ValuType = ModelEditorValueType.CheckBox,
                                    // ValidationRules = new List<ValidationItemField>
                                    // {
                                    //     new Regex
                                    //     {
                                    //         Pattern = "^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$",
                                    //         ErrorMessage = "فرمت ایمیل درست نیست."
                                    //     }
                                    // }
                                },
                                new ItemField
                                {
                                    PropertyName = "Tall",
                                    Title = "قد",
                                    ValuType = ModelEditorValueType.Number
                                },
                                new ItemField
                                {
                                    PropertyName = "Password",
                                    Title = "رمز عبور",
                                    ValuType = ModelEditorValueType.Password
                                },
                                new ItemField
                                {
                                    PropertyName = "RepeatPassword",
                                    Title = "تکرار رمز عبور",
                                    ValuType = ModelEditorValueType.Password
                                },
                                new SelectiveItemField
                                {
                                    PropertyName = "RolesId",
                                    Title = "نقش",
                                    ValuType = ModelEditorValueType.Selective,
                                    Items = _roleService.Read().Select(r=>new SelectItem
                                    {
                                        Id = r.Id,
                                    Title = r.Title
                                    }).ToList()
                                },
                        },
                        OnSubmit = (form) =>
                        {
                            var Password = form["Password"];
                            var RepeatPassword = form["RepeatPassword"];
                            if (Password != RepeatPassword)
                            {
                                _toastService.Show("رمز عبور با تکرار ان تفاوت دارد.", ToastLevel.Error, 3000, "هشدار");
                                return false;
                            }
                            var User = new User
                            {
                                FirstName = form["FirstName"],
                                LastName = form["LastName"],
                                UserName = form["UserName"],
                                Password = Password,
                                Tall = form["Tall"].ToInt32(),
                                RolesId = form["RolesId"].Split(",").Select(rid => rid.ToInt32()).ToList(),
                            };
                            _usersService.Create(User);
                            return true;
                        }
                    };
                }
            };

    }
}
