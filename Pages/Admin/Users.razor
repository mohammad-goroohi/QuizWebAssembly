@page "/Admin/Users"
@layout MainLayout
@inject UsersService _usersService
@inject RolesService _roleService


<DataGrid Config="DataGridConfig" />

@code {
    public DataGridConfig DataGridConfig { get; set; }
    protected override async Task OnInitializedAsync()
    {
        DataGridConfig = new DataGridConfig();
        DataGridConfig.Title = "لیست کاربر ها";
        DataGridConfig.GroupActions = new List<DataGridRowActionGroup>
        {
            new DataGridRowActionGroup
            {
                Width = "200px",
                Actions = new List<DataGridRowAction>
                {
                    new DataGridRowAction
                    {
                        ButtonClass = ButtonsClass.btn_primary,
                        IconClass=IconsClass.fa_pen_to_square,
                        OnClick = (rowitem) =>
                        {

                        }
                    }
                }
            }
        };

        DataGridConfig.Columns = new List<DataGridColumn>
        {
            new DataGridColumn
            {
                PropertyName = "Id",
                Title = "شناسه"
            },
            new DataGridColumn
            {
                PropertyName = "FirstName",
                Title = "نام"
            },
            new DataGridColumn
            {
                PropertyName = "LastName",
                Title = "نام خوانوادگی"
            },
            new DataGridColumn
            {
                PropertyName = "UserName",
                Title = "نام کاربری"
            },
        };
        DataGridConfig.LoadDataAsync = () =>
        {
            return Task.FromResult(_usersService.Read().Cast<dynamic>().ToList());
        };
        DataGridConfig.DeleteRowButtonDataGridConfig.OnOpenModal = (row) =>
        {
            return new ConfirmModal
                {
                    Title = "هشدار",
                    Content = "ایا از حذف این سطر مطمئن هستید؟",
                    OnConfirm = () =>
{
        _usersService.Delete(Convert.ToInt32(row["Id"]));
    }
                };
        };
        DataGridConfig.EditRowButtonDataGridConfig.OnOpenModal = (row) =>
        {
            return new InputModal
                {
                    OnSubmit = (form) =>
{
        int Id = form["Id"].ToInt32();

        var Entiry = _usersService.Read(Id);
        Entiry.FirstName = form["FirstName"];
        Entiry.LastName = form["LastName"];
        Entiry.UserName = form["UserName"];
        Entiry.UserName = form["Password"];
    //_usersService.Update(User.Id, User);
        return true;
    },
                    Fields = new List<ItemField>
                                                                        {
                                new ItemField
                                {
                                    PropertyName = "Id",
                                    Title = "شناسه",
                                    Value = row["Id"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "FirstName",
                                    Title = "نام",
                                    Value = row["FirstName"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "LastName",
                                    Title = "نام خوانوادگی",
                                    Value = row["LastName"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "UserName",
                                    Title = "نام کاربری",
                                    Value = row["UserName"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "Password",
                                    Title = "رمز عبور",
                                    Value = row["Password"],
                                    ValuType = ModelEditorValueType.Text
                                },
                                new SelectiveItemField
                                {
                                    PropertyName = "RolesId",
                                    Title = "نقش",
                                    ValuType = ModelEditorValueType.Selective,
                                    Items = _roleService.Read().Select(r=>new SelectItem
                                    {
                                        Id = r.Id,
                                    Title = r.Title
                                    }).ToList()
                                },
                                                                        }
                };
        };
        DataGridConfig.NewRowButtonDataGridConfig = new NewRowButtonDataGridConfig
            {
                ButtonTitle = "کاربر جدید",
                IsShow = true,
                OnOpenModal = () =>
                {
                    return new InputModal
                    {
                        Fields = new List<ItemField>
                        {
                                new ItemField
                                {
                                    PropertyName = "FirstName",
                                    Title = "نام",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "LastName",
                                    Title = "نام خوانوادگی",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "UserName",
                                    Title = "نام کاربری",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "Password",
                                    Title = "رمز عبور",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new ItemField
                                {
                                    PropertyName = "RepeatPassword",
                                    Title = "تکرار رمز عبور",
                                    ValuType = ModelEditorValueType.Text
                                },
                                new SelectiveItemField
                                {
                                    PropertyName = "RolesId",
                                    Title = "نقش",
                                    ValuType = ModelEditorValueType.Selective,
                                    Items = _roleService.Read().Select(r=>new SelectItem
                                    {
                                        Id = r.Id,
                                    Title = r.Title
                                    }).ToList()
                                },
                        },
                        OnSubmit = (form) =>
                        {
                            var User = new User
                            {
                                FirstName = form["FirstName"],
                                LastName = form["LastName"],
                                UserName = form["UserName"],
                                Password = form["Password"],
                                RolesId = form["RolesId"].Split(",").Select(rid=>rid.ToInt32()).ToList(),
                            };
                            _usersService.Create(User);
                            return true;
                        }
                    };
                }
            };

    }
}
