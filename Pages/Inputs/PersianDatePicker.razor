<div class="mb-3 position-relative">
    <input type="text" class="form-control" readonly value="@DisplayDate" @onclick="ToggleCalendar" />
    @if (ShowCalendar)
    {
        <div class="card shadow position-absolute mt-1" style="z-index:1000; width:300px;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <button class="btn btn-sm btn-outline-secondary" @onclick="PrevMonth">‹</button>
                <span>@PersianYear / @PersianMonth</span>
                <button class="btn btn-sm btn-outline-secondary" @onclick="NextMonth">›</button>
            </div>
            <table class="table table-bordered table-sm mb-0 text-center">
                <thead>
                    <tr>
                        @foreach (var dayName in DayNames)
                        {
                            <th>@dayName</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var week in Weeks)
                    {
                        <tr>
                            @foreach (var day in week)
                            {
                                if (day == 0)
                                {
                                    <td></td>
                                }
                                else
                                {
                                    var isSelected = (day == PersianDay);
                                    <td>
                                        <button class="btn btn-sm @(isSelected ? "btn-primary text-white" : "btn-light")"
                                                @onclick="() => SelectDay(day)">
                                            @day
                                        </button>
                                    </td>
                                }
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Parameter] public DateTime Value { get; set; } = DateTime.Now;
    [Parameter] public Action<string> oninput { get; set; }
    private bool ShowCalendar { get; set; }
    private int PersianYear, PersianMonth, PersianDay;
    private string DisplayDate => $"{PersianYear}/{PersianMonth:D2}/{PersianDay:D2}";

    private readonly System.Globalization.PersianCalendar pc = new();

    private string[] DayNames = new[] { "ش", "ی", "د", "س", "چ", "پ", "ج" };
    private List<List<int>> Weeks = new();

    protected override void OnInitialized()
    {
        PersianYear = pc.GetYear(Value);
        PersianMonth = pc.GetMonth(Value);
        PersianDay = pc.GetDayOfMonth(Value);
        BuildCalendar();
    }

    private void ToggleCalendar() => ShowCalendar = !ShowCalendar;

    private void BuildCalendar()
    {
        Weeks.Clear();
        int daysInMonth = pc.GetDaysInMonth(PersianYear, PersianMonth);
        DateTime firstDay = pc.ToDateTime(PersianYear, PersianMonth, 1, 0, 0, 0, 0);
        int startDayOfWeek = (int)firstDay.DayOfWeek; // 0=Sunday

        var week = new List<int>();
        for (int i = 0; i < startDayOfWeek; i++) week.Add(0);

        for (int day = 1; day <= daysInMonth; day++)
        {
            week.Add(day);
            if (week.Count == 7)
            {
                Weeks.Add(week);
                week = new List<int>();
            }
        }
        if (week.Count > 0) Weeks.Add(week);
    }

    private void SelectDay(int day)
    {
        PersianDay = day;
        //Value = pc.ToDateTime(PersianYear, PersianMonth, PersianDay, 0, 0, 0, 0);
        oninput($"{PersianYear}/{PersianMonth}/{PersianDay}");
        ShowCalendar = false;
    }

    private void PrevMonth()
    {
        PersianMonth--;
        if (PersianMonth < 1)
        {
            PersianMonth = 12;
            PersianYear--;
        }
        BuildCalendar();
    }

    private void NextMonth()
    {
        PersianMonth++;
        if (PersianMonth > 12)
        {
            PersianMonth = 1;
            PersianYear++;
        }
        BuildCalendar();
    }
    private void ControlChanged(ChangeEventArgs e)
    {
        var value = (bool)e.Value;
        oninput(Convert.ToString(value));
    }
}
